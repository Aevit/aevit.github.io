<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="VPS配置 - Git"/>




  <meta name="keywords" content="比特海, 后台, VPS, Git, Aevit" />










  <link rel="alternate" href="/atom.xml" title="Aevit">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.5.0" />



<link rel="canonical" href="http://aevit.xyz/2015/11/11/vps-config-git/"/>


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.5.0" />



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />




  
  <script id="baidu_analytics">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?27c09d216f39fb173da80070c4219fb8";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>









    <title> VPS配置 - Git - Aevit </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Aevit</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            首页
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            归档
          
        </li>
      </a>
    
      <a href="/tags">
        <li class="mobile-menu-item">
          
          
            标签
          
        </li>
      </a>
    
      <a href="/categories">
        <li class="mobile-menu-item">
          
          
            分类
          
        </li>
      </a>
    
      <a href="/about">
        <li class="mobile-menu-item">
          
          
            关于
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Aevit</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            
            
              标签
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/categories">
            
            
              分类
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            
            
              关于
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title-diu-helkyle">
        
          VPS配置 - Git
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2015-11-11
        </span>
        
          <div class="post-category">
            
              <a href="/categories/比特海/">比特海</a>
            
          </div>
        
        
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#在自己服务器搭建git"><span class="toc-text">在自己服务器搭建git</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#初始化裸仓库"><span class="toc-text">初始化裸仓库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实现自动布署"><span class="toc-text">实现自动布署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#从现有仓库克隆"><span class="toc-text">从现有仓库克隆</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gitignore-规则不生效的解决方法"><span class="toc-text">.gitignore 规则不生效的解决方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置SSH密钥"><span class="toc-text">配置SSH密钥</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#客户端操作"><span class="toc-text">客户端操作</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#配置单个公钥文件"><span class="toc-text">配置单个公钥文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#配置多个公钥文件"><span class="toc-text">配置多个公钥文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#附-配置ssh-agent"><span class="toc-text">附.配置ssh-agent</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#服务端操作"><span class="toc-text">服务端操作</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#创建用户"><span class="toc-text">创建用户</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#创建-ssh目录"><span class="toc-text">创建.ssh目录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#禁用shell登录"><span class="toc-text">禁用shell登录</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#客户端开始工作"><span class="toc-text">客户端开始工作</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#新仓库"><span class="toc-text">新仓库</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#已有仓库"><span class="toc-text">已有仓库</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#遇到的一个坑"><span class="toc-text">遇到的一个坑</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#其它参考资料"><span class="toc-text">其它参考资料</span></a></li></ol></li></ol>
    </div>
  </div>


    <div class="post-content">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文主要介绍如何在自己的服务器搭建 <code>Git</code>，包括以下内容：</p>
<ul>
<li>初始化祼仓库</li>
<li>实现自动布署</li>
<li>从现有仓库克隆</li>
<li><code>.gitignore</code> 规则不生效的解决方法</li>
<li>配置 <code>SSH</code> 密钥（服务器端及客户端的相关操作）</li>
<li>其它参考资料</li>
</ul>
<a id="more"></a>
<h2 id="在自己服务器搭建git"><a href="#在自己服务器搭建git" class="headerlink" title="在自己服务器搭建git"></a>在自己服务器搭建git</h2><p>Git是一个分布式版本控制／软件配置管理软件，原来是linux内核开发者林纳斯·托瓦兹为了更好地管理linux内核开发而创立的。</p>
<p>在服务器上布署共享用的git，最好是用裸仓库（bare仓库）。<br>之所以叫裸仓库，是因为其没有工作目录，只包含我们平时使用时的隐藏文件夹<code>.git</code>目录里的文件。<br>因为git本质维护的是<code>commit（提交历史）</code>，而不是<code>code（具体的代码）</code></p>
<p>裸仓库扮演的角色和中心版本控制系统中中心服务器的角色类似：你项目的中心。</p>
<h3 id="初始化裸仓库"><a href="#初始化裸仓库" class="headerlink" title="初始化裸仓库"></a>初始化裸仓库</h3><p>创建裸仓库时，只要加上参数<code>--bare</code>即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git init --bare &#123;your-project-name&#125;.git</div></pre></td></tr></table></figure>
<h3 id="实现自动布署"><a href="#实现自动布署" class="headerlink" title="实现自动布署"></a>实现自动布署</h3><p>自动布署相关资料来源：<a href="http://icyleaf.com/2012/03/apps-auto-deploy-with-git/" target="_blank" rel="external">使用 Git Hooks 实现自动项目部署</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Git 本身可以调用自定义的挂钩脚本，其中有两组：客户端和服务器端。  </div><div class="line">客户端挂钩用于客户端的操作，如提交和合并。  </div><div class="line">服务器端挂钩用于 Git 服务器端的操作，如接收被推送的提交。  </div><div class="line">详情请查看 [ProGit 相关章节](http://progit.org/book/zh/ch7-3.html)</div></pre></td></tr></table></figure>
<p>为了保证不被肆意部署，特加了一个对需要部署<code>commit</code>的判断，利用读取<code>commit subject</code>并匹配<strong>想要的字符串</strong>才去部署，这样是一个比较安全的部署方案。</p>
<p>git的挂钩（hook）有多种，详细可去bare仓库查看<code>hooks</code>目录，里面已经内置了一些文件，只需将文件后缀的<code>.sample</code>去掉即可</p>
<p>实现自动布署只需要使用<code>post-receive</code>这个<code>hook</code>即可，该<code>hook</code>会在接收post（push）请求后执行。</p>
<p>1、在上面创建的裸仓库（<code>注意是裸仓库，即bare仓库，不是代码仓库</code>）编辑</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd &#123;your_git_bare_dir&#125;</div><div class="line">vim hooks/post-receive</div></pre></td></tr></table></figure>
<p>粘贴相关代码即可（代码有点长，见文章最下面）</p>
<p>该代码会先判断脚本所在目录是否是<code>bare仓库</code>，然后获取最新<code>commit</code>的<code>subject</code>，并匹配是否包含 <code>[deploy]</code> （可修改为自己需要的字符串）字样。<br>如果包含，则继续检查产品代码仓库路径是否存在，如果存在则执行<code>git pull</code>操作。</p>
<p>2、对刚才编辑的<code>post-receive</code>执行下面命令以保证脚本可执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">chmod +x hooks/post-receive</div></pre></td></tr></table></figure>
<p>​3、之后可去客户端提交一个<strong>标题</strong>包含<code>[deploy]</code>文字的<code>commit</code>测试一下</p>
<h3 id="从现有仓库克隆"><a href="#从现有仓库克隆" class="headerlink" title="从现有仓库克隆"></a>从现有仓库克隆</h3><p>如果要把现有的<code>非祼仓库</code>在服务器上架设一个git，也只需在<code>clone</code>时加上<code>--bare</code>参数即可<br><a href="https://git-scm.com/book/zh/v1/%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E7%9A%84-Git-%E5%9C%A8%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E9%83%A8%E7%BD%B2-Git" target="_blank" rel="external">详细可阅读此文</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git clone --bare &#123;your-project-git-url&#125; &#123;your-custom-project-name&#125;</div></pre></td></tr></table></figure>
<h3 id="gitignore-规则不生效的解决方法"><a href="#gitignore-规则不生效的解决方法" class="headerlink" title=".gitignore 规则不生效的解决方法"></a><code>.gitignore</code> 规则不生效的解决方法</h3><p>有时候在项目开发过程中，突然心血来潮想把某些目录或文件加入忽略规则，按照上述方法定义后发现并未生效。</p>
<p>原因是 <code>.gitignore</code> 只能忽略那些原来没有被 <code>track</code> 的文件，如果某些文件已经被纳入了版本管理中，则修改 <code>.gitignore</code> 是无效的。那么解决方法就是先把本地缓存删除（改变成 <code>未track</code> 状态），然后再提交：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">git rm -r --cached .</div><div class="line">git add .</div><div class="line">git commit -m &apos;update .gitignore&apos;</div></pre></td></tr></table></figure>
<p>参考自 <a href="http://www.pfeng.org/archives/840" target="_blank" rel="external">Git忽略规则及.gitignore规则不生效的解决办法</a></p>
<h3 id="配置SSH密钥"><a href="#配置SSH密钥" class="headerlink" title="配置SSH密钥"></a>配置SSH密钥</h3><h4 id="客户端操作"><a href="#客户端操作" class="headerlink" title="客户端操作"></a>客户端操作</h4><p>如果在本机上只需要管理一个git的话，参照下面的<code>配置单个公钥文件</code>的方法即可；<br>如果需要管理多个（比如说管理<code>github</code> <code>gitcafe</code> <code>自己服务器上的git</code>等），需要参照下面的<code>配置多个公钥文件</code>的方法。</p>
<h5 id="配置单个公钥文件"><a href="#配置单个公钥文件" class="headerlink" title="配置单个公钥文件"></a>配置单个公钥文件</h5><p>查看是否有<code>~/.ssh</code>文件夹，没有则先创建，然后用<code>ssh-keygen</code>生成文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"># 没有.ssh文件夹，才需要创建  </div><div class="line">mkdir ~/.ssh</div><div class="line"></div><div class="line">cd ~/.ssh</div><div class="line"></div><div class="line"># -t 指定密钥类型，默认即 rsa ，可以省略  </div><div class="line"># -C 设置注释文字，比如你的邮箱（注意是大写的C，并且邮箱左右有引号）</div><div class="line"># 此方法会默认在`~/.ssh/`下生成一个名字`id_rsa`的私钥文件，及`id_rsa.pub`的公钥文件  </div><div class="line">ssh-keygen -t rsa -C &quot;&#123;your_email@email.com&#125;&quot;</div></pre></td></tr></table></figure>
<p>一步一步回车完成后，复制<code>id_rsa.pub</code>里的内容，等下粘贴到服务器上的文件中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># 复制id_rsa.pub里的内容到剪贴板，或是手动去 ~/.ssh/id_rsa.pub 复制  </div><div class="line">pbcopy &lt; ~/.ssh/id_rsa.pub</div></pre></td></tr></table></figure>
<h5 id="配置多个公钥文件"><a href="#配置多个公钥文件" class="headerlink" title="配置多个公钥文件"></a>配置多个公钥文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># 以下两种任选一种即可  </div><div class="line"># 1. 生成新的ssh key并命名为`custom_rsa`  </div><div class="line">ssh-keygen -t rsa -C &quot;your_email@email.com&quot; -f ~/.ssh/custom_rsa  </div><div class="line"></div><div class="line"># 2. 或 打以下命令后，在询问时输入名称</div><div class="line">ssh-keygen -t rsa -C &quot;your_email@email.com&quot;</div></pre></td></tr></table></figure>
<p>一步一步回车完成后，复制<code>custom_rsa.pub</code>里的内容，等下粘贴到服务器上的文件中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># 复制id_rsa.pub里的内容到剪贴板，或是手动去 ~/.ssh/custom_rsa.pub 复制    </div><div class="line">pbcopy &lt; ~/.ssh/custom_rsa.pub</div></pre></td></tr></table></figure>
<p>然后在<code>~/.ssh</code>下新建<code>config</code>文件，用于配置各个公私钥对应的主机</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vim ~/.ssh/config</div></pre></td></tr></table></figure>
<p>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"># desc: github (github@email.com)</div><div class="line">Host github.com</div><div class="line">    Hostname github.com</div><div class="line">    User git</div><div class="line">    PreferredAuthentications publickey</div><div class="line">    Identityfile ~/.ssh/github</div><div class="line"></div><div class="line"># desc: my_server_user (your_email@email.com)</div><div class="line">Host your_domain_name_or_ip</div><div class="line">    HostName your_domain_name_or_ip</div><div class="line">    User git</div><div class="line">    IdentityFile ~/.ssh/custom_rsa</div><div class="line"></div><div class="line"></div><div class="line"># 以上各字段说明：</div><div class="line"># Host：主机名字，不能重名</div><div class="line"># HostName：主机所在域名或IP</div><div class="line"># User：服务器上的用户名</div><div class="line"># PreferredAuthentications：不填此行的话，如果pubkey验证不通过可以用密码方式；填了`publickey`只能通过公钥验证的方式</div><div class="line"># IdentityFile：私钥路径</div></pre></td></tr></table></figure>
<h5 id="附-配置ssh-agent"><a href="#附-配置ssh-agent" class="headerlink" title="附.配置ssh-agent"></a>附.配置ssh-agent</h5><blockquote>
<p>PS: 正常来说，这部分ssh-agent相关内容是可以不需要用到的</p>
</blockquote>
<p>正常来说，<code>配置多个公钥文件</code>，只要上面的<code>config</code>文件正确填写，客户端的工作就完成了。<br>如果配置了<code>config</code>后，<code>git clone</code>仍需要密码，或不想通过<code>config</code>文件来配置，则可以使用<code>ssh-agent</code>的方式</p>
<p>使用方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># 把刚才生成的ssh私钥添加到ssh-agent  </div><div class="line"># 注意如果不使用 -K 参数，每次重启都会被刷新掉，得重新执行一遍才行（详见 http://segmentfault.com/q/1010000000835302/a-1020000000883441）</div><div class="line"># 加了 -K 参数（本人机子为mac），则会在`keychain`自动加上该私钥（去`keychain`里搜索`ssh`即可看到）  </div><div class="line"># 其他平台（win、linux等也有类似`keychain`的东西，这里不再详述）  </div><div class="line"></div><div class="line">ssh-add -K ~/.ssh/custom_rsa</div></pre></td></tr></table></figure>
<hr>
<p>附1. 关于创建公钥的详细信息，可以参考<a href="https://help.github.com/articles/generating-ssh-keys/" target="_blank" rel="external">https://help.github.com/articles/generating-ssh-keys/</a><br>附2. ssh-add相关命令，可以参考<a href="http://www.lampblog.net/ubuntu/ssh-add%E5%91%BD%E4%BB%A4/" target="_blank" rel="external">http://www.lampblog.net/ubuntu/ssh-add%E5%91%BD%E4%BB%A4/</a></p>
<h4 id="服务端操作"><a href="#服务端操作" class="headerlink" title="服务端操作"></a>服务端操作</h4><h5 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h5><p>一般来说，需要创建一个新用户用来给git登录及其操作，比如这里我创建一个名为<code>git</code>的用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sudo adduser git</div><div class="line"></div><div class="line"># 然后切换回刚创建的git用户来做其他操作</div><div class="line">su git</div></pre></td></tr></table></figure>
<h5 id="创建-ssh目录"><a href="#创建-ssh目录" class="headerlink" title="创建.ssh目录"></a>创建<strong>.ssh</strong>目录</h5><p>查看是否有<code>/home/git/.ssh/</code>目录，没有则创建：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mkdir /home/git/.ssh</div></pre></td></tr></table></figure>
<p>接着在<code>.ssh</code>里创建文件（要确保这个文件的<code>owner</code>为上面创建的用户，如<code>git</code>，不是的话用<code>sudo chown git.git /home/git/.ssh/authorized_keys</code>命令修改）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">vim /home/git/.ssh/authorized_keys</div><div class="line"># 粘贴刚才复制的公钥文件的内容，追加在后面，保存退出即可</div></pre></td></tr></table></figure>
<blockquote>
<p>使用 <code>ssh -vvv git@{your_ip} -p {your_port}</code> 测试不能正常连接的话，就使用下面方法检查一下</p>
</blockquote>
<ul>
<li>打开远程主机的 <code>/etc/ssh/sshd_config</code> 这个文件，检查下面几行是否被注释了:  </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">RSAAuthentication yes</div><div class="line">PubkeyAuthentication yes</div><div class="line">AuthorizedKeysFile .ssh/authorized_keys</div></pre></td></tr></table></figure>
<p>然后重启下 ssh 服务:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># CentOS 6:  </div><div class="line">service sshd restart</div><div class="line"></div><div class="line"># CentOS 7:  </div><div class="line">/bin/systemctl restart sshd.service</div></pre></td></tr></table></figure>
<ul>
<li>确认权限，<code>~/.ssh</code> 目录权限要求是 <code>700</code>，里面的 <code>~/.ssh/authorized_keys</code> 权限要求是 <code>600</code></li>
</ul>
<h5 id="禁用shell登录"><a href="#禁用shell登录" class="headerlink" title="禁用shell登录"></a>禁用shell登录</h5><p>出于安全考虑，你可以用 Git 自带的 git-shell 工具限制 git 用户的活动范围。这可以通过编辑<code>/etc/passwd</code>文件完成。找到类似下面的一行，把 <code>/bin/sh</code> 改为<code>/usr/bin/git-shell</code>（或者用 <code>which git-shell</code> 查看它的实际安装路径）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">vim /etc/passwd</div><div class="line"></div><div class="line"># 下面的`1000:1000`是在本人机器上的显示，不同机器会不一样  </div><div class="line"># 找到这行：</div><div class="line">git:x:1000:1000::/home/apps:/bin/bash</div><div class="line"></div><div class="line"># 改为：</div><div class="line">git:x:1000:1000::/home/apps:/usr/bin/git-shell</div></pre></td></tr></table></figure>
<p>现在 git 用户只能用 ssh 连接来推送和获取 Git 仓库，而不能直接使用服务器的 shell。尝试普通 ssh 登录的话，会看到拒绝信息。</p>
<h4 id="客户端开始工作"><a href="#客户端开始工作" class="headerlink" title="客户端开始工作"></a>客户端开始工作</h4><h5 id="新仓库"><a href="#新仓库" class="headerlink" title="新仓库"></a>新仓库</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">git init</div><div class="line">git remote add origin git@&#123;your_domain_name_or_ip&#125;:&#123;server_git_path&#125;/&#123;repo&#125;.git</div><div class="line">touch README.md</div><div class="line">git add .</div><div class="line">git commit -m &quot;init&quot;</div><div class="line">git push origin --all</div><div class="line"></div><div class="line"># 如果是首次建立的仓库，里面是什么东西也没的，也没有任何branch，需要手动添加点东西，commit一次之后才会有分支</div></pre></td></tr></table></figure>
<h5 id="已有仓库"><a href="#已有仓库" class="headerlink" title="已有仓库"></a>已有仓库</h5><p>修改为新的url；或直接clone在新的目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># 修改仓库的配置文件：`.git/config` 为</div><div class="line"></div><div class="line">[remote &quot;origin&quot;]</div><div class="line">    url = git@&#123;your_domain_name_or_ip&#125;:&#123;username&#125;/&#123;repo&#125;.git</div><div class="line"></div><div class="line"># 或在新的目录clone</div><div class="line">git clone git@&#123;your_domain_name_or_ip&#125;:&#123;server_git_path&#125;/&#123;repo&#125;.git</div></pre></td></tr></table></figure>
<h5 id="遇到的一个坑"><a href="#遇到的一个坑" class="headerlink" title="遇到的一个坑"></a>遇到的一个坑</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">附.操作中遇到的一个坑: 权限问题导致ssh不能连上</div><div class="line">上面配置好后，但是客户端一直用ssh连不上，使用 `ssh -vvv your_server_ip` 提示：</div><div class="line">Permission denied (publickey,gssapi-keyex,gssapi-with-mic).  </div><div class="line"></div><div class="line">查了很多资料，如:</div><div class="line">http://flysnowxf.iteye.com/blog/1567570  </div><div class="line">http://serverfault.com/questions/598058/ssh-permission-denied-publickey-gssapi-with-mic-password  </div><div class="line">但是还是不行，最后发现是因为服务器上的 `/home/git/` 目录权限之前被我设为了777，需要改为700，或744，或755才行  </div><div class="line">顺便复习一下ssh相关权限：</div><div class="line"></div><div class="line">700: /home/git (等ssh可以连通后，事后根据需要再调整为744或755)  </div><div class="line">700: /home/git/.ssh  </div><div class="line">600: /home/git/.ssh/authorized_keys</div><div class="line"></div><div class="line">详见: https://wiki.archlinux.org/index.php/SSH_keys_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)</div></pre></td></tr></table></figure>
<h3 id="其它参考资料"><a href="#其它参考资料" class="headerlink" title="其它参考资料"></a>其它参考资料</h3><ul>
<li>Git了解：<a href="http://www.bootcss.com/p/git-guide/" target="_blank" rel="external">git-简易指南</a></li>
<li>Git详细：<a href="https://git-scm.com/book/zh/v2" target="_blank" rel="external">git-scm.com</a></li>
<li>Git进阶：<a href="http://danielkummer.github.io/git-flow-cheatsheet/index.zh_CN.html" target="_blank" rel="external">git-flow 备忘清单</a></li>
<li><p>管理工具：</p>
<blockquote>
<p>目前 <code>Git</code> 服务端的管理工具（类似 <code>github</code> <code>coding</code> 等）主要有2个，一个是 <a href="https://about.gitlab.com/" target="_blank" rel="external">gitlab</a>，一个是 <a href="http://gitolite.com/gitolite/index.html" target="_blank" rel="external">gitolite</a><br>这里不再详述，具体的安装可上网查看，如:<br><a href="http://blog.51yip.com/server/1752.html" target="_blank" rel="external">centos gitolite 安装 配置 详解</a><br><a href="http://peiqiang.net/2014/07/30/install-gitlab.html" target="_blank" rel="external">gitlab安装调试小记</a></p>
</blockquote>
</li>
<li><p><a href="http://www.jianshu.com/p/f23f72251abc" target="_blank" rel="external">merge rebase 区别</a></p>
</li>
</ul>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"># 附录: git bare 仓库，实现自动布署的hook代码 vim  &#123;your_git_bare_dir&#125;/hooks/post-receive</div><div class="line"># 来源: https://gist.github.com/icyleaf/566767</div><div class="line"># 修改下面的 $DEPLOY_DIR 目录，之后提交的commit包含字符串 [deploy] 即可</div><div class="line">#!/bin/sh</div><div class="line">#</div><div class="line"># git autodeploy script when it matches the string &quot;[deploy]&quot;</div><div class="line">#</div><div class="line"># @author    icyleaf &lt;icyleaf.cn@gmail.com&gt;</div><div class="line"># @link      http://icyleaf.com</div><div class="line"># @version   0.1</div><div class="line">#</div><div class="line"># Usage:</div><div class="line">#       1. put this into the post-receive hook file itself below</div><div class="line">#       2. `chmod +x post-receive`</div><div class="line">#       3. Done!</div><div class="line"></div><div class="line"># Check the remote git repository whether it is bare</div><div class="line">IS_BARE=$(git rev-parse --is-bare-repository)</div><div class="line">if [ -z &quot;$IS_BARE&quot; ]; then</div><div class="line">    echo &gt;&amp;2 &quot;fatal: post-receive: IS_NOT_BARE&quot;</div><div class="line">    exit 1</div><div class="line">fi</div><div class="line"></div><div class="line"># get the branch name when recived</div><div class="line">if ! [ -t 0 ]; then</div><div class="line">  read -a ref</div><div class="line">fi</div><div class="line">IFS=&apos;/&apos; read -ra REF &lt;&lt;&lt; &quot;$&#123;ref[2]&#125;&quot;</div><div class="line">BRANCH=&quot;$&#123;REF[2]&#125;&quot;</div><div class="line">if [ &quot;$BRANCH&quot; == &quot;&quot; ]; then</div><div class="line">  BRANCH=&quot;develop&quot;</div><div class="line">fi</div><div class="line"># echo &gt;&amp;2 $BRANCH</div><div class="line"></div><div class="line"># Get the latest commit subject</div><div class="line"># 注：默认是取master分支上的log (git log -1)，如果想要取其他分支的，请加上分支名字，如 git log develop -1</div><div class="line">SUBJECT=$(git log $BRANCH -1 --pretty=format:&quot;%s&quot;)</div><div class="line"></div><div class="line"># Deploy the HEAD sources to publish</div><div class="line">IS_PULL=$(echo &quot;$SUBJECT&quot; | grep &quot;[deploy]&quot;)</div><div class="line">if [ -z &quot;$IS_PULL&quot; ]; then</div><div class="line">    echo &gt;&amp;2 &quot;tips: post-receive: IS_NOT_PULL&quot;</div><div class="line">    exit 1</div><div class="line">fi</div><div class="line"></div><div class="line"># Check the deploy dir whether it exists</div><div class="line">DEPLOY_DIR=/home/icyleaf/php/icyleaf/</div><div class="line">if [ ! -d $DEPLOY_DIR ] ; then</div><div class="line">    echo &gt;&amp;2 &quot;fatal: post-receive: DEPLOY_DIR_NOT_EXIST: \&quot;$DEPLOY_DIR\&quot;&quot;</div><div class="line">    exit 1</div><div class="line">fi</div><div class="line"></div><div class="line"># Check the deploy dir whether it is git repository</div><div class="line">#</div><div class="line">#IS_GIT=$(git rev-parse --git-dir 2&gt;/dev/null)</div><div class="line">#if [ -z &quot;$IS_GIT&quot; ]; then</div><div class="line">#   echo &gt;&amp;2 &quot;fatal: post-receive: IS_NOT_GIT&quot;</div><div class="line">#   exit 1</div><div class="line">#fi</div><div class="line"></div><div class="line"># Goto the deploy dir and pull the latest sources</div><div class="line">cd $DEPLOY_DIR</div><div class="line">#env -i git reset --hard</div><div class="line">env -i git pull</div></pre></td></tr></table></figure>
<hr>
<p>2015.11.11 01:53<br>Aevit<br>华师</p>
<p><a href="http://file.arvit.xyz/moon-from-650d.jpg" title="楼顶月" target="_blank" rel="external"><img src="http://file.arvit.xyz/moon-from-650d.jpg" alt=""></a></p>

      
    </div>

    
      
      



      
      
    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/比特海/">比特海</a>
            
              <a href="/tags/后台/">后台</a>
            
              <a href="/tags/VPS/">VPS</a>
            
              <a href="/tags/Git/">Git</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2015/11/22/to-tibet-pics/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">去西藏(多图)</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/2015/11/11/vps-config/">
        <span class="next-text nav-default">VPS配置</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:aevit@qq.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/aevit" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
    
      
    
      
        
          <a href="http://www.okayapi.com/?f=aevit" class="iconfont icon-pocket" title="pocket"></a>
        
      
    
      
    
    
    
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>


<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2014 - 
    
    2018

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Aevit</span>
  </span>

  <div style="width:300px;margin:0 auto; padding:20px 0;">
    <a href="javascript:void(0)" style="display:inline-block;text-decoration:none;height:20px;line-height:20px;"><img src="" style="float:left;"/><p style="float:left;height:20px;line-height:20px;margin: 0px 0px 0px 5px; color:#939393;">粤ICP备18142108号</p></a>
  </div>
    
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'http://aevit.xyz/2015/11/11/vps-config-git/';
        this.page.identifier = '2015/11/11/vps-config-git/';
        this.page.title = 'VPS配置 - Git';
    };
    (function() {
    var d = document, s = d.createElement('script');

    s.src = '//aevit.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();  
  </script>

  

  



    
  





  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  


    <script type="text/javascript" src="/js/src/even.js?v=2.5.0"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.5.0"></script>

  </body>
</html>
