<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="PhalApi(π)接口框架-计划任务开发"/>




  <meta name="keywords" content="比特海, PHP, PhalApi, Aevit" />










  <link rel="alternate" href="/default" title="Aevit">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.5.0" />



<link rel="canonical" href="http://aevit.xyz/2016/02/28/PhalApi-π-schedule-task/"/>


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.5.0" />



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />




  
  <script id="baidu_analytics">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?27c09d216f39fb173da80070c4219fb8";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>



    <title> PhalApi(π)接口框架-计划任务开发 - Aevit </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Aevit</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            Home
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            Archives
          
        </li>
      </a>
    
      <a href="/tags">
        <li class="mobile-menu-item">
          
          
            Tags
          
        </li>
      </a>
    
      <a href="/categories">
        <li class="mobile-menu-item">
          
          
            Categories
          
        </li>
      </a>
    
      <a href="/about">
        <li class="mobile-menu-item">
          
          
            About
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Aevit</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            
            
              标签
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/categories">
            
            
              分类
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            
            
              关于
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          PhalApi(π)接口框架-计划任务开发
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2016-02-28
        </span>
        
          <div class="post-category">
            
              <a href="/categories/比特海/">比特海</a>
            
          </div>
        
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#说明"><span class="toc-text">说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#下载"><span class="toc-text">下载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis-MQ、File-MQ及DB-MQ"><span class="toc-text">Redis MQ、File MQ及DB MQ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#配置"><span class="toc-text">配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#初始化"><span class="toc-text">初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#触发接口"><span class="toc-text">触发接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#计划任务处理接口"><span class="toc-text">计划任务处理接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置数据库"><span class="toc-text">配置数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动计划任务"><span class="toc-text">启动计划任务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#全量MQ"><span class="toc-text">全量MQ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#触发接口-1"><span class="toc-text">触发接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#计划任务处理接口-1"><span class="toc-text">计划任务处理接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置数据库-1"><span class="toc-text">配置数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动计划任务-1"><span class="toc-text">启动计划任务</span></a></li></ol></li></ol>
    </div>
  </div>


    <div class="post-content">
      
        <h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><blockquote>
<p><a href="http://phalapi.net/" target="_blank" rel="external">PhalApi</a>(读π框架)，是一个PHP轻量级开源接口框架，是专门为接口开发而设计的框架。<br>在这里先感谢作者@dogstar 提供了这么一个方便的php接口框架。</p>
</blockquote>
<p>本文主要记录下π框架下计划任务的相关开发教程。</p>
<p>计划任务有两种情况：<br>1、MQ（Message Queue）－消息队列：<br>服务器<strong>被动</strong>触发（循环扫描消费）。<br>举个例子：当你群发一条消息给10000（假设你有朋友）个朋友，如果直接同步发送，可能对服务器的压力会比较大，这时应该使用MQ计划任务进行分布式处理。<br>MQ具体是什么，这里就不再详细阐述了，有兴趣的同学可以自行google。<br>π框架为MQ提供了三种类型：<code>Redis</code>/<code>文件</code>/<code>数据库</code></p>
<p>2、全量：<br>服务器<strong>主动</strong>触发（定期全量执行）。<br>举个例子：假设你们有个智能产品是秤，用户通过app记录了体重，这时产品经理一拍脑袋说：“加个体重周报功能，统计一周秤重结果，分析分析你为什么这么肥，这样好不好？”。<br>这时开发人员内心当然是“你TM才肥，你全家都肥”，表面当然说“可以，使用全量计划任务，在每周一个固定时间进行统计就行了。”</p>
<a id="more"></a>
<blockquote>
<p>本文内容较多，可在PC端使用右下角按钮，查看目录</p>
</blockquote>
<hr>
<h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><p>最新框架源码可从 <a href="https://github.com/phalapi/phalapi" target="_blank" rel="external">github</a> 或 <a href="https://git.oschina.net/dogstar/PhalApi.git" target="_blank" rel="external">开源中国</a> 上下载</p>
<p>计划任务的说明及文档可查看官网:<br><a href="http://phalapi.net/wikis/%5B1.31%5D-%E6%96%B0%E5%9E%8B%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1%EF%BC%9A%E4%BB%A5%E6%8E%A5%E5%8F%A3%E5%BD%A2%E5%BC%8F%E5%AE%9E%E7%8E%B0%E7%9A%84%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1.html" target="_blank" rel="external">计划任务核心设计解读</a><br><a href="http://phalapi.net/wikis/%5B3.6%5D-%E6%89%A9%E5%B1%95%E7%B1%BB%E5%BA%93%EF%BC%9A%E6%96%B0%E5%9E%8B%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1.html" target="_blank" rel="external">计划任务官方开发文档</a></p>
<p>π框架计划任务主要功能点:</p>
<ol>
<li>提供了<strong>Redis/文件/数据库</strong>三种MQ队列及<strong>全量</strong>计划</li>
<li>提供了本地和远程两种调度方式</li>
<li>以接口的形式实现计划任务</li>
<li>提供统一的crontab调度</li>
</ol>
<p><strong>附</strong>：<br><a href="https://github.com/Aevit/PhalApi-Schedule-Task-Demo" target="_blank" rel="external">本文4种计划任务Demo源码</a><br><strong>注意</strong>：<br>请先修改<code>./config/dbs.php</code>里的数据库相关参数配置（以及表前缀<code>tables.__default__.prefix</code>）</p>
<hr>
<p>以下分别说明四种计划任务的使用：<br>Redis MQ、File MQ、数据库MQ、全量计划</p>
<h2 id="Redis-MQ、File-MQ及DB-MQ"><a href="#Redis-MQ、File-MQ及DB-MQ" class="headerlink" title="Redis MQ、File MQ及DB MQ"></a><code>Redis MQ</code>、<code>File MQ</code>及<code>DB MQ</code></h2><p>由于三种类型的MQ使用方式差别不大，这里合并为一起说明</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>———————— Redis MQ 及 File MQ 相关配置 ————————</p>
<blockquote>
<p>注意此处是<code>Redis MQ 及 File MQ</code>才需要配置</p>
</blockquote>
<p>编辑<code>./config/app.php</code>，在<code>array</code>里增加以下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * 计划任务配置</div><div class="line"> */</div><div class="line">&apos;Task&apos; =&gt; array(</div><div class="line">    // MQ队列设置，可根据使用需要配置</div><div class="line">    &apos;mq&apos; =&gt; array(</div><div class="line">    	 // Redis MQ需加此配置</div><div class="line">        &apos;redis&apos; =&gt; array(</div><div class="line">            &apos;host&apos; =&gt; &apos;127.0.0.1&apos;,</div><div class="line">            &apos;port&apos; =&gt; 6379,</div><div class="line">            &apos;prefix&apos; =&gt; &apos;phalapi_task_&apos;,</div><div class="line">            &apos;auth&apos; =&gt; &apos;&apos;,</div><div class="line">        ),</div><div class="line">    	 // File MQ需加此配置</div><div class="line">        &apos;file&apos; =&gt; array(</div><div class="line">            &apos;path&apos; =&gt; API_ROOT . &apos;/Runtime&apos;,</div><div class="line">            &apos;prefix&apos; =&gt; &apos;phalapi_task_&apos;,</div><div class="line">        ),</div><div class="line">    ),</div><div class="line"></div><div class="line">    //Runner设置，如果使用远程调度方式（即使用别的服务器来处理），请加此配置  </div><div class="line">    &apos;runner&apos; =&gt; array(</div><div class="line">        &apos;remote&apos; =&gt; array(</div><div class="line">            &apos;host&apos; =&gt; &apos;http://library.phalapi.net/demo/&apos;,</div><div class="line">            &apos;timeoutMS&apos; =&gt; 3000,</div><div class="line">        ),</div><div class="line">    ),</div><div class="line">),</div></pre></td></tr></table></figure>
<p>———————— DB MQ 相关配置 ————————</p>
<blockquote>
<p>注意此处是<code>DB MQ</code>才需要配置<br>配置DB MQ数据库有两步：创建多表、配置数据库路由；</p>
</blockquote>
<p><strong>1，创建多表</strong><br>当需要使用数据库MQ列队时，为了防止以后MQ数据过多，最好创建多个表；<br>创建表的sql语句，可使用<code>./Library/Task/Data/phalapi_task_mq.sql</code>，根据需要再去调整该sql语句（如修改表前缀等）<br>（PS：如果对此框架了解，也可使用框架提供的脚本(<code>./PhalApi/build_sqls.php</code>)来创建表，该脚本需要的sql文件可使用<code>./Library/Task/Data/task_mq.sql</code>）</p>
<p><strong>2，配置数据库路由</strong><br>分表需做好数据库路由配置，在<code>./Config/dbs.php</code>的<code>tables数组</code>里，追加<code>task_mq</code>配置即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&apos;tables&apos; =&gt; array(</div><div class="line"></div><div class="line">  //请将以下配置拷贝到 ./Config/dbs.php 文件对应的位置中，未配置的表将使用默认路由</div><div class="line"></div><div class="line">  //10张表，可根据需要，自行调整表前缀、主键名和路由</div><div class="line">  &apos;task_mq&apos; =&gt; array(</div><div class="line">      &apos;prefix&apos; =&gt; &apos;phalapi_&apos;,</div><div class="line">      &apos;key&apos; =&gt; &apos;id&apos;,</div><div class="line">      &apos;map&apos; =&gt; array(</div><div class="line">          array(&apos;db&apos; =&gt; &apos;db_demo&apos;),</div><div class="line">          array(&apos;start&apos; =&gt; 0, &apos;end&apos; =&gt; 9, &apos;db&apos; =&gt; &apos;db_demo&apos;),</div><div class="line">      ),</div><div class="line">  ),</div><div class="line">)</div></pre></td></tr></table></figure>
<p>注：如果需要使用<strong>远程调度</strong>，请参照上面<code>Redis MQ</code>，在<code>./config/app.php</code>里追加<code>Task.runner</code>的配置</p>
<hr>
<h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p>首先，在入口文件（<code>./Public/init.php</code>）进行初始化：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">DI()-&gt;loader-&gt;addDirs(&apos;Library&apos;);</div><div class="line">$mq = new Task_MQ_Redis();  // Redis MQ，请使用此句代码  </div><div class="line">// $mq = new Task_MQ_File(); // File MQ，请使用此句代码  </div><div class="line">// $mq = new Task_MQ_DB(); // DB MQ，请使用此句代码</div><div class="line">DI()-&gt;taskLite = new Task_Lite($mq);</div></pre></td></tr></table></figure>
<hr>
<h3 id="触发接口"><a href="#触发接口" class="headerlink" title="触发接口"></a>触发接口</h3><p>触发MQ计划任务的接口，跟使用框架开发普通接口一样开发即可，然后在此接口开发过程中的合适位置（如<code>Domain</code>层），加上这句代码即可添加新的任务到MQ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">// add方法的第1个参数是计划任务处理接口的service名称，第2个参数是要传递过去的参数数组  </div><div class="line">// 本Demo为了方便，将`计划任务处理接口`都使用为同一个: `./Task/Api/TTaskMQ.php`，实际应该是根据不同触发接口，实现不同`计划任务处理接口`  </div><div class="line">DI()-&gt;taskLite-&gt;add(&apos;TTaskMQ.Go&apos;, array(&apos;your_param&apos; =&gt; $yourParam));</div></pre></td></tr></table></figure>
<p>具体可查看<a href="https://github.com/Aevit/PhalApi-Schedule-Task-Demo" target="_blank" rel="external">Demo源码</a><br>增加了4个文件:<br>Redis MQ：<code>./Demo/Api/MQ/Redis.php</code>，<code>./Demo/Domain/MQ/Redis.php</code><br>File MQ：<code>./Demo/Api/MQ/File.php</code>，<code>./Demo/Domain/MQ/File.php</code><br>DB MQ：<code>./Demo/Api/MQ/DB.php</code>，<code>./Demo/Domain/MQ/DB.php</code></p>
<hr>
<h3 id="计划任务处理接口"><a href="#计划任务处理接口" class="headerlink" title="计划任务处理接口"></a>计划任务处理接口</h3><p>在上面的基础上增加好触发接口后，再进行计划任务处理接口的开发，开发方式仍同框架普通接口的开发差不多，可以同在<code>./Demo</code>目录下进行开发，也可在不同目录不一样。</p>
<blockquote>
<p>不同目录开发：<br>触发接口所在目录为: <code>./Demo</code>，计划任务所在目录可以自己定，只要目录里仍有<code>Api</code> <code>Domain</code> <code>Model</code> <code>Tests</code>等核心目录即可。如<code>./Task</code>。</p>
<p>同在<code>./Demo</code>目录开发：<br>可增加目录<code>./Demo/Task</code>，再行开发即可。</p>
</blockquote>
<p>本Demo使用的是不同目录的开发，<br>具体可查看<a href="https://github.com/Aevit/PhalApi-Schedule-Task-Demo" target="_blank" rel="external">Demo源码</a><br>增加了2个文件: <code>./Task/Api/TTaskMQ.php</code>，<code>./Task/Domain/TTaskMQ.php</code>；</p>
<p>这里为了方便，只在<code>Domain/TTaskMQ.php</code>里使用<code>var_dump</code>展示一下结果而已，具体可根据自己需要去处理操作。<br>同样为了方便，本demo代码里，3种类型的MQ<code>计划任务处理接口</code>，都使用了同一个: <code>./Task/Api/TTaskMQ.php</code>，正常来说是应该对应弄3个<code>计划任务处理接口</code>的。</p>
<hr>
<h3 id="配置数据库"><a href="#配置数据库" class="headerlink" title="配置数据库"></a>配置数据库</h3><blockquote>
<p>前提：<code>./config/dbs.php</code>里配置好数据库相关参数（帐号、密码、表前缀等）</p>
</blockquote>
<p>新建以下表（或见<code>./Library/Task/Data/phalapi_task_progress.sql</code>文件）<br>注：表前缀要跟<code>./config/dbs.php</code>里的<code>tables.__default__.prefix</code>保持一致</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">CREATE TABLE `phalapi_task_progress` (</div><div class="line">      `id` bigint(20) NOT NULL AUTO_INCREMENT,</div><div class="line">      `title` varchar(200) DEFAULT &apos;&apos; COMMENT &apos;任务标题&apos;,</div><div class="line">      `trigger_class` varchar(50) DEFAULT &apos;&apos; COMMENT &apos;触发器类名&apos;,</div><div class="line">      `fire_params` varchar(255) DEFAULT &apos;&apos; COMMENT &apos;需要传递的参数，格式自定&apos;,</div><div class="line">      `interval_time` int(11) DEFAULT &apos;0&apos; COMMENT &apos;执行间隔，单位：秒&apos;,</div><div class="line">      `enable` tinyint(1) DEFAULT &apos;1&apos; COMMENT &apos;是否启动，1启动，0禁止&apos;,</div><div class="line">      `result` varchar(255) DEFAULT &apos;&apos; COMMENT &apos;运行的结果，以json格式保存&apos;,</div><div class="line">      `state` tinyint(1) DEFAULT &apos;0&apos; COMMENT &apos;进程状态，0空闲，1运行中，-1异常退出&apos;,</div><div class="line">      `last_fire_time` int(11) DEFAULT &apos;0&apos; COMMENT &apos;上一次运行时间&apos;,</div><div class="line">      PRIMARY KEY (`id`)</div><div class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</div></pre></td></tr></table></figure>
<p>插入数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">// Redis MQ，请使用此数据  </div><div class="line">INSERT INTO `phalapi_task_progress`(title, trigger_class, fire_params, interval_time)  VALUES(&apos;你的任务名字－如Redis MQ测试&apos;, &apos;Task_Progress_Trigger_Common&apos;, &apos;TTaskMQ.Go&amp;Task_MQ_Redis&amp;Task_Runner_Local&apos;, &apos;60&apos;);</div><div class="line"></div><div class="line">// File MQ，请使用此数据  </div><div class="line">INSERT INTO `phalapi_task_progress`(title, trigger_class, fire_params, interval_time)  VALUES(&apos;你的任务名字－如File MQ测试&apos;, &apos;Task_Progress_Trigger_Common&apos;, &apos;TTaskMQ.Go&amp;Task_MQ_File&amp;Task_Runner_Local&apos;, &apos;60&apos;);</div><div class="line"></div><div class="line">// DB MQ，请使用此数据  </div><div class="line">INSERT INTO `phalapi_task_progress`(title, trigger_class, fire_params, interval_time)  VALUES(&apos;你的任务名字－如DB MQ测试&apos;, &apos;Task_Progress_Trigger_Common&apos;, &apos;TTaskMQ.Go&amp;Task_MQ_DB&amp;Task_Runner_Local&apos;, &apos;60&apos;);</div></pre></td></tr></table></figure>
<p>其中<code>fire_params</code>的值内容包含3个：</p>
<ul>
<li><code>计划任务处理接口</code>service名称，如: <code>TTaskMQ.Go</code>，本demo代码里，3种类型的MQ<code>计划任务处理接口</code>，都使用了同一个: <code>./Task/Api/TTaskMQ.php</code>，正常来说是应该对应弄3个<code>计划任务处理接口</code>的。</li>
<li>MQ类型，可选值：<code>Task_MQ_Redis</code>、<code>Task_MQ_File</code>、<code>Task_MQ_DB</code></li>
<li>调度方式，可选值：<code>Task_Runner_Local</code>、<code>Task_Runner_Remote</code></li>
</ul>
<blockquote>
<p>PS: 请仔细查看上面数据库表的各字段说明，理解各字段表示什么意思<br>PPS：上面<code>insert</code>的最后一个值<code>执行间隔</code>为<code>60</code>秒，为了等下方便查看结果，设置得比较短，具体可根据业务再调整，如<code>300</code>秒等</p>
</blockquote>
<hr>
<h3 id="启动计划任务"><a href="#启动计划任务" class="headerlink" title="启动计划任务"></a>启动计划任务</h3><p>如果<code>计划任务处理接口</code>是使用不同目录的开发，则还需要编辑<code>./Library/Task/crontab.php</code>文件，将<code>./Task</code>目录增加进来<br>（如果<code>计划任务处理接口</code>还是在<code>./Demo</code>下开发，则不用这一步）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DI()-&gt;loader-&gt;addDirs(array(&apos;./Demo&apos;, &apos;./Library&apos;, &apos;./Library/Task/Task&apos;, &apos;./Task&apos;));</div></pre></td></tr></table></figure>
<p>最后，<strong>不管</strong><code>计划任务处理接口</code>是不是在同个目录下开发，再使用<code>crontab</code>命令增加计划任务即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ crontab -e</div><div class="line"></div><div class="line">*/1 * * * * /usr/bin/php /your_project_dir/Library/Task/crontab.php &gt;&gt; /tmp/phalapi_task_crontab.log 2&gt;&amp;1</div></pre></td></tr></table></figure>
<p>其中:</p>
<ul>
<li><code>/usr/bin/php</code>请使用<code>which php</code>查询到php的执行文件先，不同系统会不一样；</li>
<li><code>/your_project_dir/Library/Task/crontab.php</code>根据自己项目位置进行调整；</li>
<li><code>/tmp/phalapi_task_crontab.log</code>建议放在项目的<code>Runtime</code>目录，这里为了方便演示就放在<code>/tmp</code>目录了</li>
</ul>
<p>最最后，进行<code>触发接口</code>的调用：</p>
<ul>
<li><p>Redis MQ触发接口：<br><code>http://api.your-domain.com/demo/?service=MQ_Redis.Go</code></p>
</li>
<li><p>File MQ触发接口：<br><code>http://api.your-domain.com/demo/?service=MQ_File.Go</code></p>
</li>
<li><p>DB MQ触发接口：<br><code>http://api.your-domain.com/demo/?service=MQ_DB.Go</code></p>
</li>
</ul>
<p>最最最后，使用以下命令，1分钟后即可看到<code>./Task/Domain/TTaskMQ.php</code>里<code>Go()</code>方法的处理结果了（遇到什么问题，注意查看此log，方便排查）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tail -f /tmp/phalapi_task_crontab.log</div></pre></td></tr></table></figure>
<blockquote>
<p>问题1：<br>如果<code>tail</code>等了很久，仍没有等到任何东西，则请先确保你的<code>计划任务处理接口</code>通过单元测试，可执行我的<a href="(https://github.com/Aevit/PhalApi-Schedule-Task-Demo">demo仓库</a>)里的单元测试文件：<br><code>phpunit ./PhalApi-Schedule-Task-Demo/Task/Tests/Api/TTaskMQ_Test.php</code></p>
<p>问题2：<br>如果<code>tail</code>等到的结果是：<br><code>PHP Fatal error: Class &#39;Redis&#39; not found in xxx</code>的错误，<br>1，确保<code>crontab -e</code>里php的<code>bin</code>路径跟<code>which php</code>的结果一样；<br>2，确保执行命令<code>php --ini</code>后<code>Loaded Configuration File</code>的文件目录，跟使用<code>web</code>访问（弄个文件，查看<code>phpinfo()</code>，如访问<a href="https://github.com/Aevit/PhalApi-Schedule-Task-Demo" target="_blank" rel="external">demo仓库</a>里的<code>http://api.your-domain.com/demo/tmp_php_info.php</code>）的一致</p>
</blockquote>
<hr>
<h2 id="全量MQ"><a href="#全量MQ" class="headerlink" title="全量MQ"></a>全量MQ</h2><h3 id="触发接口-1"><a href="#触发接口-1" class="headerlink" title="触发接口"></a>触发接口</h3><p>开发好触发器接口，开发方式同框架普通接口的开发一样即可。</p>
<p>本<a href="https://github.com/Aevit/PhalApi-Schedule-Task-Demo" target="_blank" rel="external">Demo</a>在<code>./Task</code>增加了1个文件:<br><code>./Task/TMyTrigger/AllTime.php</code></p>
<p>该文件有两点要注意：<br>1、继承接口: <code>Task_Progress_Trigger</code><br>2、实现<code>fire</code>方法，此方法内的核心代码可以参考以下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$mq = new Task_MQ_Array();</div><div class="line">$runner = new Task_Runner_Local($mq); // 如果是远程调度，使用 Task_Runner_Remote($mq)</div><div class="line"></div><div class="line">// 如果远程调度有多个不同host，可使用两句代码来初始化 runner  </div><div class="line">// $connector = new Task_Runner_Remote_Connector(array(&apos;host&apos; =&gt; &apos;AAAA&apos;));  // 指定域名</div><div class="line">// $runner = new Task_Runner_Remote($mq, 10, $connector);</div><div class="line"></div><div class="line">$service = &apos;AllTime_Schedule.Go&apos;; // 这里的service名称根据自己需要进行修改</div><div class="line">$mq-&gt;add($service, array(&apos;your_param&apos; =&gt; &apos;hey, guys, this is all_time schedule Type - 全量计划任务&apos;));</div><div class="line"></div><div class="line">$rs = $runner-&gt;go($service);</div></pre></td></tr></table></figure>
<p>PS: 触发器接口的命名及位置可以根据自己需要放置，只要最终将该接口的<code>service</code>（注意是触发器的service，不是触发器里fire方法里的处理接口service）填到后面用到的数据库里即可。</p>
<hr>
<h3 id="计划任务处理接口-1"><a href="#计划任务处理接口-1" class="headerlink" title="计划任务处理接口"></a>计划任务处理接口</h3><p>开发好你的计划任务要处理的接口，开发方式同框架普通接口的开发一样即可。</p>
<p>本<a href="https://github.com/Aevit/PhalApi-Schedule-Task-Demo" target="_blank" rel="external">Demo</a>增加了2个文件:<br><code>./Demo/Api/AllTime/Schedule.php</code><br><code>./Demo/Domain/AllTime/Schedule.php</code></p>
<p>这里为了方便，只在<code>./Demo/Domain/AllTime/Schedule.php</code>里使用<code>var_dump</code>展示一下结果而已，具体可根据自己需要去处理操作。</p>
<hr>
<h3 id="配置数据库-1"><a href="#配置数据库-1" class="headerlink" title="配置数据库"></a>配置数据库</h3><blockquote>
<p>前提：<code>./config/dbs.php</code>里配置好数据库相关参数（帐号、密码、表前缀等）</p>
</blockquote>
<p>新建以下表（或见<code>./Library/Task/Data/phalapi_task_progress.sql</code>文件）<br>注：表前缀要跟<code>./config/dbs.php</code>里的<code>tables.__default__.prefix</code>保持一致</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">CREATE TABLE `phalapi_task_progress` (</div><div class="line">      `id` bigint(20) NOT NULL AUTO_INCREMENT,</div><div class="line">      `title` varchar(200) DEFAULT &apos;&apos; COMMENT &apos;任务标题&apos;,</div><div class="line">      `trigger_class` varchar(50) DEFAULT &apos;&apos; COMMENT &apos;触发器类名&apos;,</div><div class="line">      `fire_params` varchar(255) DEFAULT &apos;&apos; COMMENT &apos;需要传递的参数，格式自定&apos;,</div><div class="line">      `interval_time` int(11) DEFAULT &apos;0&apos; COMMENT &apos;执行间隔，单位：秒&apos;,</div><div class="line">      `enable` tinyint(1) DEFAULT &apos;1&apos; COMMENT &apos;是否启动，1启动，0禁止&apos;,</div><div class="line">      `result` varchar(255) DEFAULT &apos;&apos; COMMENT &apos;运行的结果，以json格式保存&apos;,</div><div class="line">      `state` tinyint(1) DEFAULT &apos;0&apos; COMMENT &apos;进程状态，0空闲，1运行中，-1异常退出&apos;,</div><div class="line">      `last_fire_time` int(11) DEFAULT &apos;0&apos; COMMENT &apos;上一次运行时间&apos;,</div><div class="line">      PRIMARY KEY (`id`)</div><div class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</div></pre></td></tr></table></figure>
<p>插入数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">INSERT INTO `phalapi_task_progress`(title, trigger_class, fire_params, interval_time)  VALUES(&apos;你的任务名字－如全量任务测试&apos;, &apos;TMyTrigger_AllTime&apos;, &apos;&apos;, &apos;60&apos;);</div></pre></td></tr></table></figure>
<p>其中，</p>
<ul>
<li><code>trigger_class</code>的值内容是上面所写<code>触发接口</code>的`service名称；</li>
<li><code>fire_params</code>的值内容是传递给上面所写<code>触发接口</code>里<code>fire</code>方法的参数值</li>
</ul>
<blockquote>
<p>PS: 请仔细查看上面数据库表的各字段说明，理解各字段表示什么意思<br>PPS：上面<code>insert</code>的最后一个值<code>执行间隔</code>为<code>60</code>秒，为了等下方便查看结果，设置得比较短，具体可根据业务再调整，如<code>300</code>秒等</p>
</blockquote>
<hr>
<h3 id="启动计划任务-1"><a href="#启动计划任务-1" class="headerlink" title="启动计划任务"></a>启动计划任务</h3><p>根据需求，看要哪些目录还需要加载的，在<code>./Library/Task/crontab.php</code>里添加，如本demo里的全量计划任务触发器接口，是写在<code>./Task/TMyTrigger</code>里，则还需要将<code>./Task</code>目录加载进来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DI()-&gt;loader-&gt;addDirs(array(&apos;./Demo&apos;, &apos;./Library&apos;, &apos;./Library/Task/Task&apos;, &apos;./Task&apos;));</div></pre></td></tr></table></figure>
<p>最后，使用<code>crontab</code>命令增加计划任务即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ crontab -e</div><div class="line"></div><div class="line">*/1 * * * * /usr/bin/php /your_project_dir/Library/Task/crontab.php &gt;&gt; /tmp/phalapi_task_crontab.log 2&gt;&amp;1</div></pre></td></tr></table></figure>
<p>其中:</p>
<ul>
<li><code>/usr/bin/php</code>请使用<code>which php</code>查询到php的执行文件先，不同系统会不一样；</li>
<li><code>/your_project_dir/Library/Task/crontab.php</code>根据自己项目位置进行调整；</li>
<li><code>/tmp/phalapi_task_crontab.log</code>建议放在项目的<code>Runtime</code>目录，这里为了方便演示就放在<code>/tmp</code>目录了</li>
</ul>
<p>最后，使用以下命令，1分钟后即可看到<code>./Demo/Domain/AllTime/Schedule.php</code>里的处理结果了（遇到什么问题，注意查看此log，方便排查）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tail -f /tmp/phalapi_task_crontab.log</div></pre></td></tr></table></figure>
<hr>
<p><strong>附</strong>：<br><a href="https://github.com/Aevit/PhalApi-Schedule-Task-Demo" target="_blank" rel="external">本文4种计划任务Demo源码</a><br><strong>注意</strong>：<br>请先修改<code>./config/dbs.php</code>里的数据库相关参数配置（以及表前缀<code>tables.__default__.prefix</code>）</p>
<p>想要体验本Demo的不同MQ，只需增加相应数据库表及数据，再修改<code>./Public/init.php</code>里<code>mq</code>的初始化即可: <code>$mq = new Task_MQ_Redis();</code>，然后调用不同的触发接口即可</p>
<ul>
<li><p>Redis MQ触发接口：<br><code>http://api.your-domain.com/demo/?service=MQ_Redis.Go</code></p>
</li>
<li><p>File MQ触发接口：<br><code>http://api.your-domain.com/demo/?service=MQ_File.Go</code></p>
</li>
<li><p>DB MQ触发接口：<br><code>http://api.your-domain.com/demo/?service=MQ_DB.Go</code></p>
</li>
<li><p>查看结果（正常一两分钟后即可查看到结果）：<br><code>tail -f /tmp/phalapi_task_crontab.log</code></p>
</li>
</ul>

      
    </div>

    
      
      



      
      
    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/比特海/">比特海</a>
            
              <a href="/tags/PHP/">PHP</a>
            
              <a href="/tags/PhalApi/">PhalApi</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2016/03/07/sketch-study-2/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">sketch设计学习（二）</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/2016/02/25/laravel-learning-1/">
        <span class="next-text nav-default">Laravel学习笔记（一）</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>  
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:aevit@qq.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/aevit" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
    
    
      
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>


<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2014 - 
    
    2017

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Aevit</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'http://aevit.xyz/2016/02/28/PhalApi-π-schedule-task/';
        this.page.identifier = '2016/02/28/PhalApi-π-schedule-task/';
        this.page.title = 'PhalApi(π)接口框架-计划任务开发';
    };
    (function() {
    var d = document, s = d.createElement('script');

    s.src = '//aevit.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();  
  </script>




    
  





  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  


    <script type="text/javascript" src="/js/src/even.js?v=2.5.0"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.5.0"></script>
<script type="text/javascript" src="/js/src/coding_splash.js?v=2.5.0"></script>
  </body>
</html>
