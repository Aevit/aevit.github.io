<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="使用ngrok进行内网穿透"/>




  <meta name="keywords" content="比特海, 后台, ngrok, 微信公众号, Aevit" />










  <link rel="alternate" href="/atom.xml" title="Aevit">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.5.0" />



<link rel="canonical" href="http://aevit.xyz/2016/03/31/ngrok/"/>


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.5.0" />



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />




  
  <script id="baidu_analytics">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?27c09d216f39fb173da80070c4219fb8";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>



    <title> 使用ngrok进行内网穿透 - Aevit </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Aevit</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            Home
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            Archives
          
        </li>
      </a>
    
      <a href="/tags">
        <li class="mobile-menu-item">
          
          
            Tags
          
        </li>
      </a>
    
      <a href="/categories">
        <li class="mobile-menu-item">
          
          
            Categories
          
        </li>
      </a>
    
      <a href="/about">
        <li class="mobile-menu-item">
          
          
            About
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Aevit</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            
            
              标签
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/categories">
            
            
              分类
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            
            
              关于
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          使用ngrok进行内网穿透
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2016-03-31
        </span>
        
          <div class="post-category">
            
              <a href="/categories/比特海/">比特海</a>
            
          </div>
        
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GO安装"><span class="toc-text">GO安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#设置环境变量"><span class="toc-text">设置环境变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#下载源码安装"><span class="toc-text">下载源码安装</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ngrok安装"><span class="toc-text">ngrok安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#git版本"><span class="toc-text">git版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#下载ngrok源码"><span class="toc-text">下载ngrok源码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#生成证书"><span class="toc-text">生成证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编译ngrokd和ngrok"><span class="toc-text">编译ngrokd和ngrok</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#编译linux端版本"><span class="toc-text">编译linux端版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#编译mac端版本"><span class="toc-text">编译mac端版本</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#设置域名解析"><span class="toc-text">设置域名解析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用方法"><span class="toc-text">使用方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#服务端"><span class="toc-text">服务端</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#nginx端口转发"><span class="toc-text">nginx端口转发</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#启动服务端ngrok"><span class="toc-text">启动服务端ngrok</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#客户端"><span class="toc-text">客户端</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在本地进行微信公众号的调试"><span class="toc-text">在本地进行微信公众号的调试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#遇到的问题"><span class="toc-text">遇到的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ngrok端口的防火墙问题"><span class="toc-text">ngrok端口的防火墙问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ngrok的交叉编译"><span class="toc-text">ngrok的交叉编译</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li></ol>
    </div>
  </div>


    <div class="post-content">
      
        <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="http://music.163.com/outchain/player?type=2&amp;id=27591140&amp;auto=0&amp;height=66"></iframe>

<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>进行微信公众号的开发时，需要有公网IP的服务器才行，这样每次都得在本地开发再把代码提交到服务器，或直接在服务器上开发，不是很方便。<br>并且有时可能需要<code>把本机开发的网站等web项目给其他人演示</code>，以前都是上传到VPS上，也不是很方便。</p>
<p>通过google查找到<code>ngrok</code>这个东西，可以实现在本地开发即时调试，可以非常方便地实现内网穿透。</p>
<a id="more"></a>
<blockquote>
<p>ngrok 是一个反向代理，通过在公共的端点和本地运行的 Web 服务器之间建立一个安全的通道。ngrok 可捕获和分析所有通道上的流量，便于后期分析和重放。<br>详细介绍可以看百度百科的介绍：<a href="http://baike.baidu.com/view/13085941.htm" target="_blank" rel="external">ngrok介绍</a>。</p>
</blockquote>
<p>国内有些人也贡献了自己的服务器，如<a href="http://ngrok.cc/" target="_blank" rel="external">http://ngrok.cc/</a>，如果不想自己搭建<code>ngrok</code>环境，可以直接去使用。</p>
<p><code>ngrok</code>的<a href="https://github.com/inconshreveable/ngrok" target="_blank" rel="external">v1.x版本</a>是开源的，2.0就不是开源，而且两者的命令有些不同。</p>
<p>这里使用其1.x的开源代码进行布署。经过几个小时的奋斗，中间遇到一些坑，终于在VPS上弄好，现记录如下。</p>
<blockquote>
<p>拿了两台服务器进行了安装和测试，系统分别为<code>CentOS 7 64bit</code>，<code>CentOS 6.5 64bit</code></p>
</blockquote>
<h2 id="GO安装"><a href="#GO安装" class="headerlink" title="GO安装"></a>GO安装</h2><p>需要先安装go环境</p>
<h3 id="设置环境变量"><a href="#设置环境变量" class="headerlink" title="设置环境变量"></a>设置环境变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># 可以根据自己需要调整路径  </div><div class="line">echo &apos;export GOROOT=/usr/local/go&apos; &gt;&gt; /etc/profile</div><div class="line">echo &apos;export PATH=$PATH:$GOROOT/bin&apos; &gt;&gt; /etc/profile</div><div class="line">echo &apos;export GOPATH=$HOME/go&apos; &gt;&gt; /etc/profile</div><div class="line">echo &apos;export GOROOT_BOOTSTRAP=/usr/local/go&apos; &gt;&gt; /etc/profile</div></pre></td></tr></table></figure>
<h3 id="下载源码安装"><a href="#下载源码安装" class="headerlink" title="下载源码安装"></a>下载源码安装</h3><blockquote>
<p>由于<code>yum</code>安装的<code>go</code>版本是<code>1.4</code>的，后面可能会有点问题，所以这里采用源码安装（2016.03.31最新版本为1.6）的方式</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cd ~/your_download_dir</div><div class="line">wget https://storage.googleapis.com/golang/go1.6.linux-amd64.tar.gz</div><div class="line">tar -C /usr/local -xzf go1.6.linux-amd64.tar.gz</div></pre></td></tr></table></figure>
<p>查看是否安装成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">go version</div><div class="line"># 正常的话会返回类似这样的信息: go version go1.6 linux/amd64</div></pre></td></tr></table></figure>
<h2 id="ngrok安装"><a href="#ngrok安装" class="headerlink" title="ngrok安装"></a>ngrok安装</h2><h3 id="git版本"><a href="#git版本" class="headerlink" title="git版本"></a>git版本</h3><p>如果你的git版本<code>&gt;=1.7.9.5</code>，可以直接跳过git版本这一步；如果不是，需要先进行升级。<br>我在一台服务器上的版本是<code>1.7.1</code>，在ngrok安装过程中，会一直卡在某个东西的下载，我是卡在这里</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gopkg.in/inconshreveable/go-update.v0 (download)</div></pre></td></tr></table></figure>
<p>最好先进行一些git依赖的安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum -y install zlib-devel openssl-devel perl hg cpio expat-devel gettext-devel curl curl-devel perl-ExtUtils-MakeMaker hg wget gcc gcc-c++</div></pre></td></tr></table></figure>
<p>然后再升级<code>git</code>版本，升级方法是先安装第三方源(<a href="http://www.live-in.org/archives/998.html" target="_blank" rel="external">rpmfore</a>)，再使用该源进行git的更新。</p>
<p>这里不再详细说明<code>git</code>的升级，大体可以照这篇<a href="https://segmentfault.com/a/1190000002729908" target="_blank" rel="external">教程</a>弄；<br>唯一不同的是，因为启用了<code>priorities</code>，所以在最后更新git时一直查找的是<code>base</code>的<code>repo</code>，而不是<code>rpmforge</code>的<code>repo</code>，所以需要在更新时将<code>base,updates</code>等<code>repo</code>禁用（参考这篇<a href="http://akyl.net/how-install-latest-version-git-centos-6x" target="_blank" rel="external">文章</a>），如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum --disablerepo=base,updates --enablerepo=rpmforge-extras update git</div></pre></td></tr></table></figure>
<h3 id="下载ngrok源码"><a href="#下载ngrok源码" class="headerlink" title="下载ngrok源码"></a>下载ngrok源码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cd ~/your_download_dir</div><div class="line">git clone https://github.com/inconshreveable/ngrok.git ngrok</div><div class="line">cd ngrok</div></pre></td></tr></table></figure>
<h3 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h3><p>注意这里有个<code>NGROK_BASE_DOMAIN</code>；<br>假设最终需要提供的地址为<code>aevit.your-domain.com</code>，则<code>NGROK_BASE_DOMAIN</code>设置为<code>your-domain.com</code>；<br>假设最终需要提供的地址为<code>aevit.ngrok.your-domain.com</code>，则<code>NGROK_BASE_DOMAIN</code>设置为<code>ngrok.your-domain.com</code>；</p>
<p>下面以<code>ngrok.your-domain.com</code>为例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">openssl genrsa -out rootCA.key 2048</div><div class="line">openssl req -x509 -new -nodes -key rootCA.key -subj &quot;/CN=ngrok.your-domain.com&quot; -days 5000 -out rootCA.pem</div><div class="line">openssl genrsa -out device.key 2048</div><div class="line">openssl req -new -key device.key -subj &quot;/CN=ngrok.your-domain.com&quot; -out device.csr</div><div class="line">openssl x509 -req -in device.csr -CA rootCA.pem -CAkey rootCA.key -CAcreateserial -out device.crt -days 5000</div></pre></td></tr></table></figure>
<p>执行完以上命令，就会在<code>ngrok</code>目录下新生成6个文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">device.crt</div><div class="line">device.csr</div><div class="line">device.key</div><div class="line">rootCA.key</div><div class="line">rootCA.pem</div><div class="line">rootCA.srl</div></pre></td></tr></table></figure>
<p><code>ngrok</code>通过<code>bindata</code>将ngrok源码目录下的<code>assets</code>目录（资源文件）打包到可执行文件(<code>ngrokd</code>和<code>ngrok</code>)中 去，<code>assets/client/tls</code> 和 <code>assets/server/tls</code> 下分别存放着用于<code>ngrok</code>和<code>ngrokd</code>的默认证书文件，我们需要将它们<strong>替换</strong>成我们自己生成的：(因此这一步<strong>务必</strong>放在编译可执行文件之前)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cp rootCA.pem assets/client/tls/ngrokroot.crt</div><div class="line">cp device.crt assets/server/tls/snakeoil.crt</div><div class="line">cp device.key assets/server/tls/snakeoil.key</div></pre></td></tr></table></figure>
<h3 id="编译ngrokd和ngrok"><a href="#编译ngrokd和ngrok" class="headerlink" title="编译ngrokd和ngrok"></a>编译ngrokd和ngrok</h3><h4 id="编译linux端版本"><a href="#编译linux端版本" class="headerlink" title="编译linux端版本"></a>编译linux端版本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">make clean</div><div class="line"></div><div class="line"># 如果是32位系统，这里 GOARCH=386</div><div class="line">GOOS=linux GOARCH=amd64 make release-server release-client</div></pre></td></tr></table></figure>
<p>最后成功的话，会在当前目录生成一个<code>bin</code>文件夹，里面包含了<code>ngrokd</code>和<code>ngrok</code>文件；<br>其中，<code>bin/ngrokd</code>文件是服务端程序；<br><code>bin/ngrok</code>文件是客户端程序（注意上面指定了<code>GOOS</code>为64位linux的，所以这个文件是不能在<code>mac</code>或<code>win</code>等其他平台跑的，下面将进行说明如何交叉编译）</p>
<h4 id="编译mac端版本"><a href="#编译mac端版本" class="headerlink" title="编译mac端版本"></a>编译mac端版本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">cd ~/your_download_dir/ngrok</div><div class="line"></div><div class="line"># 如果是win端版本，GOOS=windows；如果是32位系统，GOARCH=386</div><div class="line">GOOS=darwin GOARCH=amd64 make release-client</div></pre></td></tr></table></figure>
<p>成功的话，会在<code>./bin/darwin_amd64/</code>下有个文件，将这个文件下载到mac上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># 如果服务器没装sz程序，请先安装（yum -y install lrzsz）；或自行采用其他办法下载到本机  </div><div class="line">sz ./bin/darwin_amd64/ngrok</div></pre></td></tr></table></figure>
<h3 id="设置域名解析"><a href="#设置域名解析" class="headerlink" title="设置域名解析"></a>设置域名解析</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># 如果最终需要的ngrok地址为: example.your-domain.com，则</div><div class="line">设置 * 记录指向服务器IP</div><div class="line"></div><div class="line"># 如果最终需要的ngrok地址为: example.ngrok.your-domain.com，则</div><div class="line">设置 *.ngrok 记录指向服务器IP</div><div class="line"></div><div class="line"># 或者不想进行泛解析，则手动添加即可，如设置example记录指向服务器IP，example.ngrok记录指向服务器IP</div></pre></td></tr></table></figure>
<h3 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h3><h4 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h4><h5 id="nginx端口转发"><a href="#nginx端口转发" class="headerlink" title="nginx端口转发"></a>nginx端口转发</h5><p>由于本机的<code>80</code>端口已经被占用了，所以需要利用<code>nginx</code>进行端口的转发，加上如下配置即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># 根据自己nginx的安装路径，自动调整以下命令</div><div class="line">vim /usr/local/nginx/conf/vhost/nginx.your-domain.com.conf</div></pre></td></tr></table></figure>
<p>内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">upstream ngrok &#123;</div><div class="line">        server 127.0.0.1:8777; # 此处端口要跟 启动服务端ngrok 时指定的端口一致</div><div class="line">        keepalive 64;</div><div class="line">&#125;</div><div class="line">server &#123;</div><div class="line">        listen 80;</div><div class="line">        server_name *.ngrok.your-domain.com;</div><div class="line">        access_log /data/wwwlogs/ngrok.your-domain.com_access.log;</div><div class="line">        error_log /data/wwwlogs/ngrok.your-domain.com_error.log;</div><div class="line">        location / &#123;</div><div class="line">                proxy_set_header X-Real-IP $remote_addr;</div><div class="line">                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</div><div class="line">                proxy_set_header Host  $http_host:8777; # 此处端口要跟 启动服务端ngrok 时指定的端口一致</div><div class="line">                proxy_set_header X-Nginx-Proxy true;</div><div class="line">                proxy_set_header Connection &quot;&quot;;</div><div class="line">                proxy_pass      http://ngrok;</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>重启nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">nginx -t</div><div class="line">nginx -s reload</div></pre></td></tr></table></figure>
<h5 id="启动服务端ngrok"><a href="#启动服务端ngrok" class="headerlink" title="启动服务端ngrok"></a>启动服务端ngrok</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"># domain填写刚才生成证书时的 NGROK_BASE_DOMAIN</div><div class="line"># http和https端口可以自己指定，这里不采用80端口，是因为其他程序已经占用了，端口转发在上面nginx已经配置完成  </div><div class="line">bin/ngrokd -domain=&quot;ngrok.your-domain.com&quot; -httpAddr=&quot;:8777&quot; -httpsAddr=&quot;:8778&quot;</div><div class="line"></div><div class="line"># 如果想要后台启动，执行以下命令  </div><div class="line">nohup bin/ngrokd -domain=&quot;ngrok.your-domain.com&quot; -httpAddr=&quot;:8777&quot; -httpsAddr=&quot;:8778&quot;   &gt; /dev/null 2&gt;&amp;1 &amp;</div><div class="line"></div><div class="line"># 如果想要开机启动，执行以下命令</div><div class="line">vim /etc/rc.d/rc.local</div><div class="line"># 添加以下内容，具体内容请根据自己情况自行调整</div><div class="line">&#123;your-ngrok-dir&#125;/bin/ngrokd -domain=&quot;ngrok.your-domain.com&quot; -httpAddr=&quot;:8777&quot;  -httpsAddr=&quot;:8778&quot;  &gt; /var/log/ngrok.log &amp;</div></pre></td></tr></table></figure>
<h4 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h4><p>确保刚才下载的mac版<code>ngrok</code>有执行权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">chmod +x ngrok</div></pre></td></tr></table></figure>
<p>在<code>ngrok</code>程序的同级目录下，编写配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vim ngrok.cfg</div></pre></td></tr></table></figure>
<p>内容如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">server_addr: &quot;ngrok.your-domain.com:4443&quot;</div><div class="line">trust_host_root_certs: false</div><div class="line">tunnels:</div><div class="line">  example:</div><div class="line">   subdomain: &quot;example&quot; #定义服务器分配域名前缀</div><div class="line">   proto:</div><div class="line">    http: 80 #映射端口，不加ip默认本机</div><div class="line">    https: 80</div><div class="line">  web:</div><div class="line">   subdomain: &quot;web&quot; #定义服务器分配域名前缀</div><div class="line">   proto:</div><div class="line">    http: 192.168.1.100:80 #映射端口，可以通过加ip为内网任意一台映射</div><div class="line">    https: 192.168.1.100:80</div><div class="line">  web1:</div><div class="line">    hostname: &quot;ngrok.your-domain.com&quot;</div><div class="line">    proto:</div><div class="line">      http: 80</div><div class="line">  web2:</div><div class="line">    hostname: &quot;your-domain.com&quot;</div><div class="line">    proto:</div><div class="line">      http: 80</div><div class="line">  ssh:</div><div class="line">   remote_port: 50001 #服务器分配tcp转发端口，如果不填写此项则由服务器分配</div><div class="line">   proto:</div><div class="line">    tcp: 22 #映射本地的22端口</div><div class="line">  ssh1: #将由服务器分配端口</div><div class="line">    proto:</div><div class="line">      tcp: 21</div></pre></td></tr></table></figure>
<p>启动<code>ngrok</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">./ngrok -subdomain example -config=ngrok.cfg 80</div><div class="line"></div><div class="line"># 或者</div><div class="line">./ngrok -config ngrok.cfg start example</div><div class="line"></div><div class="line"># 如果出现问题连接不上，想在本地查看日志，可加上log参数</div><div class="line"># ./ngrok -log ngrok.log -config ngrok.cfg start example</div><div class="line"></div><div class="line"># 最终如果`Tunnel Status`显示`online`则表示成功了</div></pre></td></tr></table></figure>
<h3 id="在本地进行微信公众号的调试"><a href="#在本地进行微信公众号的调试" class="headerlink" title="在本地进行微信公众号的调试"></a>在本地进行微信公众号的调试</h3><p>接下来就可以进行微信公众号在本地的开发了，只要在本地设置好<code>nginx</code>（<code>server_name</code>要跟上文对应，如上面的<code>example.ngrok.your-domain.com</code>）</p>
<blockquote>
<p>由于微信只允许使用80端口，所以一定要进行上面的nginx的端口转发设置才行</p>
</blockquote>
<p>另外，<code>ngrok</code>本身提供了<code>127.0.0.1:4040</code>这个地址，可以查看到所有的http数据包内容（在php文件里<code>var_dump</code>的东西也可以看到）</p>
<h3 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h3><h4 id="ngrok端口的防火墙问题"><a href="#ngrok端口的防火墙问题" class="headerlink" title="ngrok端口的防火墙问题"></a>ngrok端口的防火墙问题</h4><p>由于服务器上开启了防火墙，使用的是<code>iptables</code>，所以需要将上面的端口添加到白名单<br>（一共3个，一个是<code>ngrok</code>自身的<code>4443</code>端口，还有自定义的<code>8777</code>http端口，<code>8778</code>https端口）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vim /etc/sysconfig/iptables</div></pre></td></tr></table></figure>
<p>添加以下内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">-A RH-Firewall-1-INPUT -m state -state NEW -m tcp -p tcp -dport 4443 -j ACCEPT  </div><div class="line">-A RH-Firewall-1-INPUT -m state -state NEW -m tcp -p tcp -dport 8777 -j ACCEPT  </div><div class="line">-A RH-Firewall-1-INPUT -m state -state NEW -m tcp -p tcp -dport 8778 -j ACCEPT</div></pre></td></tr></table></figure>
<p>重启iptables</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service iptables restart</div></pre></td></tr></table></figure>
<h4 id="ngrok的交叉编译"><a href="#ngrok的交叉编译" class="headerlink" title="ngrok的交叉编译"></a>ngrok的交叉编译</h4><p>在服务器上要编译个<code>mac</code>端的版本时，网上说需要进行go的源码，去进行GOOS的设置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd /usr/local/go/src</div><div class="line">GOOS=darwin GOARCH=amd64 CGO_ENABLED=0 ./make.bash</div></pre></td></tr></table></figure>
<p>但是我拿另一台服务器测试过后，不用这样也行，直接按刚才上面说的，在<code>ngrok</code>目录去进行<code>mac端版本</code>的编译即可。</p>
<blockquote>
<p>PS: 以下内容不能看也行，只是中间遇到的问题的一些记录而已</p>
</blockquote>
<p>我第一次照着网上说的去go源码设置GOOS，反而会报这样的错：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">go ./make.bash: eval: line 135: syntax error near unexpected token `( </div><div class="line">ERROR: Cannot find /root/go1.4/bin/go.</div><div class="line">Set $GOROOT_BOOTSTRAP to a working Go tree &gt;= Go 1.4.</div></pre></td></tr></table></figure>
<p>google了下，说现在新的go都不用C编写了，而1.4之前的是C编写的，所以需要先安装1.4的，才能编译1.6的，于是便先安装了1.4，再安装1.6，步骤如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">echo &apos;export GOROOT=/usr/local/go&apos; &gt;&gt; /etc/profile</div><div class="line">echo &apos;export PATH=$PATH:$GOROOT/bin&apos; &gt;&gt; /etc/profile</div><div class="line">echo &apos;export GOPATH=$HOME/go&apos; &gt;&gt; /etc/profile</div><div class="line">echo &apos;export GOROOT_BOOTSTRAP=/usr/local/go&apos; &gt;&gt; /etc/profile</div><div class="line">source /etc/profile</div><div class="line"></div><div class="line">cd ~/your_download_dir</div><div class="line"></div><div class="line"># 先下载1.4的源码</div><div class="line">wget https://storage.googleapis.com/golang/go1.4.3.linux-amd64.tar.gz</div><div class="line">tar -C /usr/local -xzf go1.4.3.linux-amd64.tar.gz</div><div class="line">#tar -xzf go1.4.3.linux-amd64.tar.gz</div><div class="line">#mv ./go /usr/local/go</div><div class="line">cd /usr/local/go/src</div><div class="line">./all.bash</div><div class="line"></div><div class="line"># 查看版本，现在是1.4.3的</div><div class="line">go version</div><div class="line"></div><div class="line"># 将1.4的源码目录名更改为go1.4，go这个目录名等下给1.6用</div><div class="line">mv /usr/local/go/ /usr/local/go1.4/</div><div class="line"></div><div class="line"></div><div class="line">vim /etc/profile</div><div class="line"># 默认的 GOROOT_BOOTSTRAP 是: $HOME/go1.4，因为我放在了`/usr/local/go1.4`，所以这里要指定该值</div><div class="line">export GOROOT_BOOTSTRAP=/usr/local/go1.4</div><div class="line"></div><div class="line">cd ~/your_download_dir</div><div class="line">wget https://storage.googleapis.com/golang/go1.6.linux-amd64.tar.gz</div><div class="line">tar -C /usr/local -xzf go1.6.linux-amd64.tar.gz</div><div class="line">cd /usr/local/go/src</div><div class="line">./all.bash</div><div class="line"></div><div class="line"># 查看版本，现在是1.6的</div><div class="line">go version</div></pre></td></tr></table></figure>
<p>最后再次进行测试验证了不用先安装1.4再安装1.6这么麻烦。。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>中间虽然遇到了一些坑，google查了好几个钟的资料，昨晚弄到凌晨2点多，不过最终弄成功，并且验证了一些安装过程的想法，还是挺有成就感的。</p>
<p>还好大学时就有稍微折腾过linux，去年转后台开发时就用上了一些知识，现在服务器遇到一些基本问题最终也能解决了。<br>所以还是不能停止学习的脚步啊。</p>
<p>趁现在还年轻，多折腾。。</p>
<hr>
<p>2016.3.31 21:31 春天<br>Aevit<br>华师一课</p>
<p><a href="http://aevit.qiniudn.com/b2b2face1d613264cc7ad65a874fa4df1459405671.jpeg" title="厦门曾厝垵" target="_blank" rel="external"><img src="http://aevit.qiniudn.com/b2b2face1d613264cc7ad65a874fa4df1459405671.jpeg" alt=""></a><br>摄影：Aevit 2014年4月 厦门曾厝垵</p>

      
    </div>

    
      
      



      
      
    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/比特海/">比特海</a>
            
              <a href="/tags/后台/">后台</a>
            
              <a href="/tags/ngrok/">ngrok</a>
            
              <a href="/tags/微信公众号/">微信公众号</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2016/05/07/css-center/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">CSS居中</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/2016/03/08/ku-gua-pai-gu-tang/">
        <span class="next-text nav-default">苦瓜排骨汤</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>  
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:aevit@qq.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/aevit" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
    
    
  </div>


<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2014 - 
    
    2017

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Aevit</span>
  </span>
  <p>Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a></p>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'http://aevit.xyz/2016/03/31/ngrok/';
        this.page.identifier = '2016/03/31/ngrok/';
        this.page.title = '使用ngrok进行内网穿透';
    };
    (function() {
    var d = document, s = d.createElement('script');

    s.src = '//aevit.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();  
  </script>




    
  





  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  


    <script type="text/javascript" src="/js/src/even.js?v=2.5.0"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.5.0"></script>
  </body>
</html>
